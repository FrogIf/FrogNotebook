<!DOCTYPE html>
<html>
<head>
<title>6_procedure_and_function.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E5%92%8C%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0">存储过程和存储函数</h1>
<h2 id="61-%E6%A6%82%E8%BF%B0">6.1 概述</h2>
<p><strong>权限</strong></p>
<ul>
<li>创建: CREATE ROUTINE</li>
<li>修改/删除: ALTER ROUTINE</li>
<li>执行: EXECUTE</li>
</ul>
<p><strong>存储过程与存储函数的区别</strong></p>
<ol>
<li>存储过程没有返回值, 存储函数有;</li>
<li>存储过程的参数可以使用IN, OUT, INOUT类型参数, 存储函数只能使用IN类型参数.</li>
</ol>
<h2 id="62-%E5%88%9B%E5%BB%BA-%E4%BF%AE%E6%94%B9-%E5%88%A0%E9%99%A4-%E6%9F%A5%E7%9C%8B-%E8%B0%83%E7%94%A8">6.2 创建, 修改, 删除, 查看, 调用</h2>
<p><strong>创建</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> sp_name ([proc_parameter1, ...])
[characteristic ...]
routine_body

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> sp_name ([func_parameter1, ...])
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">type</span>
[characteristic ...]
routine_body

    pro_parameter:
        [<span class="hljs-keyword">IN</span>|<span class="hljs-keyword">OUT</span>|INOUT] param_name <span class="hljs-keyword">type</span>
    
    <span class="hljs-keyword">type</span>:
        <span class="hljs-keyword">Any</span> valid MySQL <span class="hljs-keyword">data</span> <span class="hljs-keyword">type</span>
    
    characteristic:
        <span class="hljs-keyword">LANGUAGE</span> <span class="hljs-keyword">SQL</span>
        | [<span class="hljs-keyword">NOT</span>] <span class="hljs-keyword">DETERMINISTIC</span>
        | {CONTAINS <span class="hljs-keyword">SQL</span>|<span class="hljs-keyword">NO</span> <span class="hljs-keyword">SQL</span>|<span class="hljs-keyword">READS</span> <span class="hljs-keyword">SQL</span> <span class="hljs-keyword">DATA</span>|MODIFIES <span class="hljs-keyword">SQL</span> <span class="hljs-keyword">DATA</span>}
        | <span class="hljs-keyword">SQL</span> <span class="hljs-keyword">SECURITY</span> {DEFINER|INVOKER}
        | <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'str_comment'</span>
</div></code></pre>
<p>对characteristic(特征值)部分的简单说明</p>
<ul>
<li>LANGUAGE SQL: 说明routine_body使用的是SQL编写</li>
<li>[NOT] DETERMINISTIC: (不)确定的, 即指定是否只要输入参数一样则输出也一样</li>
<li>{CONSTAINS SQL | NO SQL | READ SQL DATA | MODIFIES SQL DATA}: 这些特征值只是提供给服务器用, 并没有根据这些特征值限制routine_body实际的执行行为.
<ul>
<li>CONSTAINS SQL : 子程序不包含读或写数据的语句.(如果没有指定, 默认是这个)</li>
<li>NO SQL: 子程序不包含SQL语句</li>
<li>READS SQL DATA: 子程序包含读数据的语句, 但是没有写数据的语句</li>
<li>MODIFIES SQL DATA: 表示子程序包含写数据的语句.</li>
</ul>
</li>
<li>SQL SECURITY {DEFINER|INVOKER} : 指定routine_type中的命令是使用创建者的权限执行, 还是调用者的权限执行. 默认是DEFINER.</li>
<li>COMMENT 'str_comment': 注释</li>
</ul>
<p><strong>修改</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">ALTER</span> {<span class="hljs-keyword">PROCEDURE</span>|<span class="hljs-keyword">FUNCTION</span>} sp_name [characteristic ...];
</div></code></pre>
<p><strong>删除</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">DROP</span> {<span class="hljs-keyword">PROCEDURE</span>|<span class="hljs-keyword">FUNCTION</span>} [<span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span>] sp_name;
</div></code></pre>
<p><strong>查看</strong></p>
<ol>
<li>查看状态</li>
</ol>
<pre class="hljs"><code><div><span class="hljs-keyword">SHOW</span> {<span class="hljs-keyword">PROCEDURE</span>|<span class="hljs-keyword">FUNCTION</span>} <span class="hljs-keyword">STATUS</span> [<span class="hljs-keyword">LIKE</span> <span class="hljs-string">'pattern'</span>];
</div></code></pre>
<ol start="2">
<li>查看定义</li>
</ol>
<pre class="hljs"><code><div><span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">CREATE</span> {<span class="hljs-keyword">PROCEDURE</span>|<span class="hljs-keyword">FUNCTION</span>} sp_name;
</div></code></pre>
<p><strong>调用</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CALL</span> sp_name([parameter, ...])
</div></code></pre>
<p><strong>简单例程</strong></p>
<pre class="hljs"><code><div>mysql&gt; delimiter $$
mysql&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> pro_demo(<span class="hljs-keyword">IN</span> ord_id <span class="hljs-built_in">INT</span>, <span class="hljs-keyword">OUT</span> ord_date DATETIME)
    -&gt; <span class="hljs-keyword">BEGIN</span>
    -&gt;     <span class="hljs-keyword">SELECT</span> order_date <span class="hljs-keyword">INTO</span> ord_date <span class="hljs-keyword">from</span> orders <span class="hljs-keyword">WHERE</span> order_num = ord_id;
    -&gt; <span class="hljs-keyword">END</span>$$
<span class="hljs-keyword">Query</span> OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.00</span> sec)

mysql&gt; delimiter ;
mysql&gt; <span class="hljs-keyword">call</span> pro_demo(<span class="hljs-string">'20005'</span>, @a);
Query OK, 1 row affected (0.00 sec)

mysql&gt; <span class="hljs-keyword">select</span> @a;
+<span class="hljs-comment">---------------------+</span>
| @a                  |
+<span class="hljs-comment">---------------------+</span>
| 2005-09-01 00:00:00 |
+<span class="hljs-comment">---------------------+</span>
1 row in <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)
</div></code></pre>
<blockquote>
<p>delimiter用于修改sql结束符, 防止routine_body中的分号使得还没定义好过程就直接结束</p>
</blockquote>
<h2 id="63-routine-body">6.3 routine body</h2>
<p>routine body一般都是以begin开头, 以end结尾的:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">BEGIN</span>
    ...
<span class="hljs-keyword">END</span>
</div></code></pre>
<p>routine body中可以分为几部分:</p>
<ol>
<li>声明</li>
<li>执行</li>
</ol>
<p>声明部分必须在routine body的最开始部分, 可以用来定义:</p>
<ul>
<li>局部变量</li>
<li>情况</li>
<li>光标</li>
<li>情况处理</li>
</ul>
<p>并且这四者的定义顺序必须严格按照上面列出的顺序.</p>
<p>执行部分就可以写一些查询sql, 并且可以使用传统的三大编程结构了(顺序, 分支, 循环)</p>
<h3 id="631-%E5%8F%98%E9%87%8F">6.3.1 变量</h3>
<p>mysql变量分为四种:</p>
<ol>
<li>局部变量: 生命周期在BEGIN...END之间</li>
<li>用户变量: 生命周期从用户连接到用户断开</li>
<li>会话变量: 生命周期与用户变量一样, 仅限于当前连接</li>
<li>全局变量: 全局变量影响服务器整体操作。当服务器启动时，它将所有全局变量初始化为默认值。这些默认值可以在选项文件中或在命令行中指定的选项进行更改。要想更改全局变量，必须具有super权限。全局变量作用于server的整个生命周期，但是不能跨重启。即重启后所有设置的全局变量均失效。要想让全局变量重启后继续生效，需要更改相应的配置文件。</li>
</ol>
<blockquote>
<p>会话变量和全局变量又统称为系统变量, 系统变量使用时, 变量名前需要加两个@</p>
</blockquote>
<blockquote>
<p>此外, mysql中的变量是不区分大小写的</p>
</blockquote>
<p><strong>局部变量</strong></p>
<p>变量的定义:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">DECLARE</span> var_name[, ...] <span class="hljs-keyword">type</span> [<span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">value</span>];
</div></code></pre>
<p>赋值:</p>
<pre class="hljs"><code><div>直接赋值:
<span class="hljs-keyword">SET</span> var_name1 = expr1, var_name2 = expr2, ...

查询结果赋值给指定变量(这种复制方式必须保证查询结果只有一行)
<span class="hljs-keyword">SELECT</span> col_name1, col_name2, ... <span class="hljs-keyword">INTO</span> var_name1, var_name2, ... table_expr
</div></code></pre>
<p><strong>用户变量</strong></p>
<p>不需要事先生命, 直接使用:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">SET</span> @var_name = expr;
<span class="hljs-keyword">SET</span> @var_name := expr;
<span class="hljs-keyword">SELECT</span> @var_name := expr ...;
</div></code></pre>
<blockquote>
<p>强调一下, 在SELECT语句中只能使用&quot;:=&quot;为用户变量赋值</p>
</blockquote>
<blockquote>
<p>用户变量的类型是可变的, 赋什么值就是什么类型</p>
</blockquote>
<p><strong>会话变量</strong></p>
<p>会话变量在每次建立一个新的连接的时候，由MySQL来初始化。MySQL会将当前所有全局变量的值复制一份。来做为会话变量。也就是说，如果在建立会话以后，没有手动更改过会话变量与全局变量的值，那所有这些变量的值都是一样的。</p>
<p>可以通过以下命令查看当前所有会话变量:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">show</span> <span class="hljs-keyword">session</span> <span class="hljs-keyword">variables</span>;
</div></code></pre>
<p>会话变量也不需要事先声明:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">SET</span> <span class="hljs-keyword">SESSION</span> var_name = <span class="hljs-keyword">value</span>;
<span class="hljs-keyword">SET</span> @@SESSION.var_name = <span class="hljs-keyword">value</span>;
<span class="hljs-keyword">SET</span> var_name = <span class="hljs-keyword">value</span>;   <span class="hljs-comment"># 默认使用SESSION</span>
</div></code></pre>
<p>查看会话变量:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">SELECT</span> @@var_name;
<span class="hljs-keyword">SELECT</span> @@session.var_name;
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">SESSION</span> <span class="hljs-keyword">VARIABLES</span> <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'pattern'</span>;
</div></code></pre>
<blockquote>
<p>注意, 上面所有的SESSION关键字都可以使用LOCAL替换</p>
</blockquote>
<p><strong>全局变量</strong></p>
<p>同样不需要事先声明:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> var_name = <span class="hljs-keyword">value</span>;
<span class="hljs-keyword">SET</span> @@GLOBAL.var_name = <span class="hljs-keyword">value</span>;
</div></code></pre>
<blockquote>
<p>全局变量的赋值时需要有super权限的</p>
</blockquote>
<p>查看全局变量:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">SELECT</span> @@GLOBAL.var_name;
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">VARIABLES</span> <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'pattern'</span>;
</div></code></pre>
<h3 id="632-%E6%83%85%E5%86%B5%E5%8F%8A%E5%A4%84%E7%90%86">6.3.2 情况及处理</h3>
<p>情况的定义:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">DECLARE</span> condition_name CONDITION <span class="hljs-keyword">FOR</span> condition_value;

    condition_value:
        SQLSTATE [VALUE] sqlstate_value
        | mysql_error_code
</div></code></pre>
<p>情况的处理:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">DECLARE</span> hander_type <span class="hljs-keyword">HANDLER</span> <span class="hljs-keyword">FOR</span> condition_value1[, condition_value2, ...] sp_statement

    handler_type:
        CONTINUE
        |<span class="hljs-keyword">EXIT</span>
        |<span class="hljs-keyword">UNDO</span>
    
    condition_value:
        <span class="hljs-keyword">SQLSTATE</span> [<span class="hljs-keyword">value</span>] sqlstate_value
        |condition_name
        |SQLWARNING
        |<span class="hljs-keyword">NOT</span> <span class="hljs-keyword">FOUND</span>
        |SQLEXCEPTION
        |mysql_error_code
</div></code></pre>
<ul>
<li>SQLWARNING: 代表所有以01开头的SQLSTATE</li>
<li>NOT FOUND: 代表所有以02开头的SQLSTATE</li>
<li>SQLEXCEPTOIN: 代表所有没有被SQLWARNING和NOT FOUND包含的SQLSTATE</li>
</ul>
<p>handler_type实际上只支持两种, CONTINUE表示继续执行下面的语句, EXIT表示执行终止, UNDO在5.0版本中暂不支持.</p>
<p>sp_statement参数表示要执行存储过程或函数语句.</p>
<h3 id="633-%E6%B8%B8%E6%A0%87">6.3.3 游标</h3>
<p>游标的作用是在存储过程和存储函数中对结果集进行循环处理.</p>
<p>游标的使用包含四部分:</p>
<ol>
<li>声明<pre class="hljs"><code><div><span class="hljs-keyword">DECLARE</span> cursor_name <span class="hljs-keyword">CURSOR</span> <span class="hljs-keyword">FOR</span> select_statement;
</div></code></pre>
</li>
<li>OPEN<pre class="hljs"><code><div>OPEN cursor_name;
</div></code></pre>
</li>
<li>FETCH<pre class="hljs"><code><div>FETCH cursor_name INTO var_name [, var_name] ...
</div></code></pre>
</li>
<li>CLOSE<pre class="hljs"><code><div>CLOSE cursor_name;
</div></code></pre>
</li>
</ol>
<blockquote>
<p>游标一般配合循环一起使用</p>
</blockquote>
<h3 id="634-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6">6.3.4 流程控制</h3>
<p>mysql中的流程控制分为以下几个:</p>
<ol>
<li>分支: IF, CASE</li>
<li>循环: LOOP, REPEAT, WHILE</li>
<li>其他: LEAVE, ITERATE</li>
</ol>
<p><strong>IF</strong></p>
<pre class="hljs"><code><div>IF search_condition THEN statement_list
[ELSEIF search_condition THEN statement_list]
[ELSE statement_list]
<span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>
</div></code></pre>
<p><strong>CASE</strong></p>
<pre class="hljs"><code><div>CASE case_value
WHEN when_value then statement_list
[WHEN when_value then statement_list]
[WHEN when_value then statement_list]
...
[ELSE statement_list]
<span class="hljs-keyword">END</span> <span class="hljs-keyword">CASE</span>
</div></code></pre>
<p><strong>LOOP</strong></p>
<pre class="hljs"><code><div>[begin_label:] LOOP
    statement_list
<span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span> [end_label]
</div></code></pre>
<blockquote>
<p>LOOP需要显式指定退出语句, 否则是死循环</p>
</blockquote>
<p><strong>WHILE</strong></p>
<pre class="hljs"><code><div>[begin_label:] WHILE search_condition <span class="hljs-keyword">DO</span>
    statement_list
<span class="hljs-keyword">END</span> <span class="hljs-keyword">WHILE</span> [end_label]
</div></code></pre>
<p><strong>REPEAT</strong></p>
<pre class="hljs"><code><div>[begin_label:] REPEAT
    statement_list
UNTIL search_condition
<span class="hljs-keyword">END</span> <span class="hljs-keyword">REPEAT</span> [end_label]
</div></code></pre>
<blockquote>
<p>REPEAT相当于java中的do...while();</p>
</blockquote>
<p><strong>LEAVE和ITERATE</strong></p>
<p>LEAVE可以用在BEGIN...END或者循环中, 在BEGIN...END中, 相当于&quot;return;&quot;, 在循环中相当于break
ITERATE只能用于循环中, 相当于continue</p>
<p>这两个关键字后面都必须加label_name, 用于指定跳出哪一个循环:</p>
<pre class="hljs"><code><div>LEAVE lable_name;
ITERATE lable_name;
</div></code></pre>
<h2 id="64-%E5%BA%94%E7%94%A8">6.4 应用</h2>
<pre class="hljs"><code><div>mysql&gt; delimiter $$
mysql&gt; <span class="hljs-keyword">create</span> <span class="hljs-keyword">procedure</span> pro_test()
    -&gt; <span class="hljs-keyword">begin</span>
    -&gt;     <span class="hljs-keyword">declare</span> k <span class="hljs-built_in">int</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span>;
	-&gt;     <span class="hljs-keyword">declare</span> done <span class="hljs-built_in">int</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span>;
	-&gt;     <span class="hljs-keyword">declare</span> donec CONDITION <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SQLSTATE</span> <span class="hljs-string">'02000'</span>;
    -&gt;     <span class="hljs-keyword">declare</span> cs <span class="hljs-keyword">cursor</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">select</span> order_num <span class="hljs-keyword">from</span> orders;
	-&gt;     <span class="hljs-keyword">declare</span> CONTINUE <span class="hljs-keyword">HANDLER</span> <span class="hljs-keyword">FOR</span> donec <span class="hljs-keyword">set</span> done = <span class="hljs-number">1</span>;
    -&gt;
    -&gt;     <span class="hljs-keyword">set</span> @x = <span class="hljs-number">0</span>;
    -&gt;     open cs;
    -&gt;
    -&gt;     fr: loop
    -&gt;         fetch cs into k;
	-&gt;         if done then 
	-&gt;              leave fr;
    -&gt;         <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
    -&gt;         <span class="hljs-keyword">set</span> @x = @x + <span class="hljs-number">1</span>;
    -&gt;     <span class="hljs-keyword">end</span> <span class="hljs-keyword">loop</span>;
    -&gt;
    -&gt;     close cs;
    -&gt; <span class="hljs-keyword">end</span>$$
<span class="hljs-keyword">Query</span> OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.00</span> sec)
mysql&gt; delimiter ;
mysql&gt; <span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">from</span> orders;
+<span class="hljs-comment">----------+</span>
| count(*) |
+<span class="hljs-comment">----------+</span>
|        9 |
+<span class="hljs-comment">----------+</span>
1 row in <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)

mysql&gt; <span class="hljs-keyword">call</span> pro_test();
Query OK, 0 rows affected (0.00 sec)

mysql&gt; <span class="hljs-keyword">select</span> @x;
+<span class="hljs-comment">------+</span>
| @x   |
+<span class="hljs-comment">------+</span>
|    9 |
+<span class="hljs-comment">------+</span>
1 row in <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)

mysql&gt; delimiter $$
mysql&gt; <span class="hljs-keyword">create</span> <span class="hljs-keyword">function</span> fun_test() <span class="hljs-keyword">returns</span> <span class="hljs-built_in">int</span>
    -&gt; <span class="hljs-keyword">begin</span>
    -&gt;     <span class="hljs-keyword">declare</span> tempv <span class="hljs-built_in">int</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span>;
    -&gt;     <span class="hljs-keyword">declare</span> c <span class="hljs-built_in">int</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span>;
    -&gt;     <span class="hljs-keyword">declare</span> done <span class="hljs-built_in">int</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span>;
    -&gt;     <span class="hljs-keyword">declare</span> order_cs <span class="hljs-keyword">cursor</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">select</span> order_num <span class="hljs-keyword">from</span> orders;
    -&gt;     <span class="hljs-keyword">declare</span> CONTINUE <span class="hljs-keyword">HANDLER</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">FOUND</span> <span class="hljs-keyword">set</span> done = <span class="hljs-number">1</span>;
    -&gt;
    -&gt;     open order_cs;
    -&gt;     fr: loop
    -&gt;         fetch order_cs into tempv;
    -&gt;         if done then
    -&gt;              leave fr;
    -&gt;         <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
    -&gt;         <span class="hljs-keyword">set</span> c = c + <span class="hljs-number">1</span>;
    -&gt;     <span class="hljs-keyword">end</span> <span class="hljs-keyword">loop</span>;
    -&gt;
    -&gt;     close order_cs;
    -&gt;
    -&gt;     return c;
    -&gt; <span class="hljs-keyword">end</span>$$
<span class="hljs-keyword">Query</span> OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.00</span> sec)

mysql&gt; delimiter ;
mysql&gt; <span class="hljs-keyword">select</span> fun_test();
+<span class="hljs-comment">------------+</span>
| fun_test() |
+<span class="hljs-comment">------------+</span>
|          9 |
+<span class="hljs-comment">------------+</span>
1 row in <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)


</div></code></pre>

</body>
</html>
